<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>黑白棋解說譜瀏覽器</title>
  <style>
    :root { --cell: 54px; --gap: 14px; }
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 0; padding: 18px; background:#0f172a; color:#e2e8f0; }
    .app { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1.05fr 0.95fr; gap: var(--gap); }
    @media (max-width: 980px){ .app{ grid-template-columns: 1fr; } :root{ --cell: 46px; } }

    .panel { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 14px; padding: 14px; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .rowLeft { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    select, button {
      border-radius: 12px; padding: 9px 12px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      color:#e2e8f0;
    }
    button { cursor:pointer; }
    button:hover { background: rgba(255,255,255,0.12); }
    button:active { transform: translateY(1px); }
    button:disabled { opacity: 0.5; cursor:not-allowed; }

    .pill { padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); font-size: 14px; }
    .muted { opacity: 0.85; font-size: 13px; line-height:1.45; }

    .boardWrap { display:flex; justify-content:center; }
    .board {
      display:grid;
      grid-template-columns: repeat(8, var(--cell));
      grid-template-rows: repeat(8, var(--cell));
      gap: 2px;
      background: rgba(255,255,255,0.08);
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      user-select:none;
      touch-action: manipulation;
    }
    .cell {
      width: var(--cell); height: var(--cell);
      background: #166534;
      border-radius: 10px;
      position: relative;
      outline: 1px solid rgba(0,0,0,0.15);
      display:flex; align-items:center; justify-content:center;
    }
    .disc {
      width: calc(var(--cell) * 0.68);
      height: calc(var(--cell) * 0.68);
      border-radius: 50%;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.12), 0 10px 18px rgba(0,0,0,0.35);
    }
    .black { background: radial-gradient(circle at 35% 30%, #64748b 0%, #111827 60%, #0b1220 100%); }
    .white { background: radial-gradient(circle at 35% 30%, #ffffff 0%, #e2e8f0 55%, #cbd5e1 100%); }

    .lastMove::after{
      content:"";
      position:absolute;
      width: calc(var(--cell) * 0.28);
      height: calc(var(--cell) * 0.28);
      border-radius: 8px;
      border: 2px solid rgba(250,204,21,0.95);
      box-shadow: 0 0 0 3px rgba(250,204,21,0.18);
    }

    .right {
      display:flex;
      flex-direction:column;
      gap: var(--gap);
      min-height: 0;
    }
    .moves {
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-height: 0;
    }
    .list {
      overflow:auto;
      max-height: 320px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.12);
    }
    .item {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      cursor:pointer;
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .item:last-child { border-bottom: 0; }
    .item:hover { background: rgba(255,255,255,0.06); }
    .item.active { background: rgba(250,204,21,0.10); outline: 1px solid rgba(250,204,21,0.20); }
    .tag { font-size: 12px; opacity: 0.85; white-space:nowrap; }
    .mainText { font-size: 14px; line-height: 1.35; }
    .detailBox {
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.12);
      padding: 12px;
      min-height: 120px;
      white-space: pre-wrap;
      line-height: 1.5;
      font-size: 14px;
    }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; padding: 2px 6px; border-radius: 8px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); }

    .error {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(248,113,113,0.35);
      background: rgba(248,113,113,0.10);
      color: #fecaca;
      font-size: 13px;
      line-height: 1.45;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Left: board + controls -->
    <div class="panel">
      <h1>黑白棋解說譜瀏覽器</h1>

      <div class="row">
        <div class="rowLeft">
          <span class="pill">對局：</span>
          <select id="gameSelect" aria-label="Select game"></select>
          <span class="pill">步數：<b id="stepText">0</b>/<b id="totalText">0</b></span>
          <span class="pill">黑：<b id="bCount">2</b>　白：<b id="wCount">2</b></span>
        </div>

        <div class="rowLeft">
          <button id="firstBtn">⏮ 第一手</button>
          <button id="prevBtn">◀ 上一手</button>
          <button id="nextBtn">下一手 ▶</button>
          <button id="lastBtn">最後一手 ⏭</button>
        </div>
      </div>

      <p class="muted" style="margin:10px 0 0;">
        快捷鍵：<span class="kbd">←</span>/<span class="kbd">→</span> 前後手、<span class="kbd">Home</span>/<span class="kbd">End</span> 首尾。
      </p>

      <div id="errorBox" class="error" style="display:none;"></div>

      <div style="height:12px;"></div>
      <div class="boardWrap">
        <div class="board" id="board" aria-label="Othello board"></div>
      </div>
    </div>

    <!-- Right: commentary -->
    <div class="right">
      <div class="panel moves">
        <div class="row">
          <div class="rowLeft">
            <span class="pill">步驟清單（點選可跳轉）</span>
          </div>
        </div>

        <div class="list" id="moveList" aria-label="Move list"></div>

        <div class="detailBox" id="detailBox">（尚未載入對局）</div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ========== 分檔資料模式 ==========
  // 1) 先讀取 ./data/index.json 取得清單
  // 2) 依選取讀取 ./data/<file> (例如 games/demo-1.json)
  //
  // index.json 建議格式：[{id,title,file}, ...]
  // 單盤 json 建議格式：{id,title,meta,moves:[{move,comment}, ...]}

  // ===== Othello engine (apply moves only, no legality UI) =====
  const N = 8;
  const EMPTY = 0, BLACK = 1, WHITE = 2;
  const dirs = [
    [-1,-1],[-1,0],[-1,1],
    [0,-1],        [0,1],
    [1,-1],[1,0],[1,1]
  ];
  function other(p){ return p===BLACK ? WHITE : BLACK; }
  function inBounds(r,c){ return r>=0 && r<N && c>=0 && c<N; }

  function initBoard(){
    const b = Array.from({length:N}, () => Array(N).fill(EMPTY));
    b[3][3] = WHITE; b[3][4] = BLACK;
    b[4][3] = BLACK; b[4][4] = WHITE;
    return b;
  }

  // Parse "d3" -> {r,c} where a1 = (0,0), or "pass"
  function parseMove(s){
    if (!s) return null;
    const t = String(s).trim().toLowerCase();
    if (t === "pass") return { pass:true };
    const file = t.charCodeAt(0) - "a".charCodeAt(0);
    const rank = parseInt(t.slice(1), 10) - 1;
    if (Number.isNaN(rank) || file < 0 || file >= 8 || rank < 0 || rank >= 8) return null;
    return { r: rank, c: file, pass:false };
  }

  function getFlips(board, r, c, p){
    if (board[r][c] !== EMPTY) return [];
    const opp = other(p);
    const flips = [];
    for (const [dr,dc] of dirs){
      let rr = r + dr, cc = c + dc;
      const line = [];
      while (inBounds(rr,cc) && board[rr][cc] === opp){
        line.push([rr,cc]);
        rr += dr; cc += dc;
      }
      if (line.length && inBounds(rr,cc) && board[rr][cc] === p) flips.push(...line);
    }
    return flips;
  }

  function applyMove(board, moveObj, p){
    if (moveObj.pass) return { ok:true, last:null, board };
    const {r,c} = moveObj;
    const flips = getFlips(board, r, c, p);
    if (!flips.length) return { ok:false, last:null, board };
    board[r][c] = p;
    for (const [rr,cc] of flips) board[rr][cc] = p;
    return { ok:true, last:{r,c}, board };
  }

  function countDiscs(board){
    let b=0,w=0;
    for (let r=0;r<N;r++){
      for (let c=0;c<N;c++){
        if (board[r][c]===BLACK) b++;
        else if (board[r][c]===WHITE) w++;
      }
    }
    return {b,w};
  }

  // ===== UI elements =====
  const boardEl = document.getElementById("board");
  const gameSelect = document.getElementById("gameSelect");
  const moveListEl = document.getElementById("moveList");
  const detailBox = document.getElementById("detailBox");
  const errorBox = document.getElementById("errorBox");

  const stepText = document.getElementById("stepText");
  const totalText = document.getElementById("totalText");
  const bCountEl = document.getElementById("bCount");
  const wCountEl = document.getElementById("wCount");

  const firstBtn = document.getElementById("firstBtn");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const lastBtn = document.getElementById("lastBtn");

  // ===== App state =====
  let gameIndex = [];         // from data/index.json
  let currentGame = null;     // loaded game json
  let currentIndex = 0;       // which entry in gameIndex
  let step = 0;               // 0..moves.length

  function showError(msg){
    errorBox.style.display = "block";
    errorBox.textContent = msg;
  }
  function clearError(){
    errorBox.style.display = "none";
    errorBox.textContent = "";
  }

  async function fetchJson(url){
    // no-store to reduce caching issues after updates on GitHub Pages
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`${url} 讀取失敗（HTTP ${res.status}）`);
    return await res.json();
  }

  function normalizeIndexEntry(e){
    // allow {id,title,file} minimal
    const id = String(e?.id ?? "");
    const title = String(e?.title ?? id ?? "Untitled");
    const file = String(e?.file ?? "");
    if (!id || !file) return null;
    return { id, title, file };
  }

function normalizeGame(g){
  const id = String(g?.id ?? "");
  const title = String(g?.title ?? id ?? "");
  const meta = String(g?.meta ?? "");

  // 新結構必備：record（每 2 字元一手，如 "f5d6c3..."）
  const record = String(g?.record ?? "").trim().toLowerCase();
  if (!record) throw new Error("對局檔格式錯誤：缺少 record");

  // 可選：comments 物件，key = 第幾手（1-based），value = 解說
  const comments = (g?.comments && typeof g.comments === "object") ? g.comments : {};

  // 基本檢查：長度必須是 2 的倍數
  if (record.length % 2 !== 0) {
    throw new Error("record 長度錯誤：必須是 2 的倍數（每手 2 字元）");
  }

  const moves = [];
  for (let i = 0; i < record.length; i += 2) {
    const step = (i / 2) + 1;         // 1-based
    const move = record.slice(i, i + 2);

    moves.push({
      move,
      comment: String(comments[String(step)] ?? comments[step] ?? "")
    });
  }

  return { id, title, meta, moves };
}

  function computePosition(game, step){
    let board = initBoard();
    let turn = BLACK;
    let last = null;

    for (let i=0;i<step;i++){
      const m = game.moves[i];
      const mo = parseMove(m.move);
      if (!mo) { turn = other(turn); continue; }

      const res = applyMove(board, mo, turn);
      if (res.ok) last = res.last;

      // PASS 或不合法也照樣換手，讓解說譜能順著走
      turn = other(turn);
    }
    return { board, turn, last };
  }

  function renderBoard(board, last){
    boardEl.innerHTML = "";
    for (let r=0;r<N;r++){
      for (let c=0;c<N;c++){
        const cell = document.createElement("div");
        cell.className = "cell";
        if (last && last.r===r && last.c===c) cell.classList.add("lastMove");

        const v = board[r][c];
        if (v !== EMPTY){
          const d = document.createElement("div");
          d.className = "disc " + (v===BLACK ? "black" : "white");
          cell.appendChild(d);
        }
        boardEl.appendChild(cell);
      }
    }
  }

  function renderMoveList(game){
    moveListEl.innerHTML = "";

    const initItem = document.createElement("div");
    initItem.className = "item" + (step===0 ? " active":"");
    initItem.innerHTML = `
      <div>
        <div class="mainText"><b>初始局面</b></div>
        <div class="tag">Step 0</div>
      </div>
      <div class="tag">—</div>
    `;
    initItem.addEventListener("click", () => { step = 0; renderAll(); });
    moveListEl.appendChild(initItem);

    for (let i=0;i<game.moves.length;i++){
      const m = game.moves[i];
      const s = i+1;
      const item = document.createElement("div");
      item.className = "item" + (step===s ? " active":"");

      const player = (i % 2 === 0) ? "黑" : "白";
      const moveText = (String(m.move).toLowerCase()==="pass") ? "PASS" : String(m.move);
      const shortComment = (m.comment || "").trim().replace(/\s+/g," ");
      const preview = shortComment.length ? shortComment.slice(0, 24) + (shortComment.length>24 ? "…" : "") : "";

      item.innerHTML = `
        <div>
          <div class="mainText"><b>${player}</b>：${moveText}</div>
          <div class="tag">${preview}</div>
        </div>
        <div class="tag">Step ${s}</div>
      `;
      item.addEventListener("click", () => { step = s; renderAll(); });
      moveListEl.appendChild(item);
    }
  }

  function renderDetail(game){
    if (step === 0){
      detailBox.textContent = game.meta ? `【對局資訊】\n${game.meta}` : "（初始局面）";
      return;
    }
    const i = step - 1;
    const m = game.moves[i];
    const player = (i % 2 === 0) ? "黑" : "白";
    const moveText = (String(m.move).toLowerCase()==="pass") ? "PASS" : String(m.move);
    const comment = (m.comment || "").trim();
    detailBox.textContent =
      `Step ${step}\n${player}：${moveText}\n\n` + (comment.length ? comment : "");
  }

function renderHeader(game, pos){
  if (stepText) stepText.textContent = step;
  if (totalText) totalText.textContent = game.moves.length;

  const {b,w} = countDiscs(pos.board);
  if (bCountEl) bCountEl.textContent = b;
  if (wCountEl) wCountEl.textContent = w;

  const atStart = step === 0;
  const atEnd = step === game.moves.length;
  if (firstBtn) firstBtn.disabled = atStart;
  if (prevBtn)  prevBtn.disabled  = atStart;
  if (nextBtn)  nextBtn.disabled  = atEnd;
  if (lastBtn)  lastBtn.disabled  = atEnd;
}

  function renderAll(){
    if (!currentGame){
      detailBox.textContent = "（尚未載入對局）";
      return;
    }
    const pos = computePosition(currentGame, step);
    renderBoard(pos.board, pos.last);
    renderMoveList(currentGame);
    renderDetail(currentGame);
    renderHeader(currentGame, pos);

    const active = moveListEl.querySelector(".item.active");
    if (active) active.scrollIntoView({ block: "nearest" });
  }

async function loadIndex(){
  clearError();
  const idx = await fetchJson("./data/index.json?v=" + Date.now());
  if (!Array.isArray(idx)) throw new Error("index.json 格式錯誤：必須是 JSON 陣列");

    const normalized = idx.map(normalizeIndexEntry).filter(Boolean);
    if (!normalized.length) throw new Error("index.json 沒有任何有效項目（需要 id + file）");

    gameIndex = normalized;

    gameSelect.innerHTML = "";
    gameIndex.forEach((g, i) => {
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = g.title || g.id;
      gameSelect.appendChild(opt);
    });

    currentIndex = 0;
    gameSelect.value = "0";
    gameSelect.addEventListener("change", async () => {
      currentIndex = Number(gameSelect.value);
      await loadGame(currentIndex);
    });
  }

async function loadGame(i){
  clearError();
  step = 0;
  currentGame = null;
  renderAll();

  const entry = gameIndex[i];
  if (!entry) throw new Error("找不到對局索引項目");

  const game = normalizeGame(
    await fetchJson("./data/" + entry.file + "?v=" + Date.now())
  );
    if (!game.moves) throw new Error("對局檔格式錯誤：缺少 moves");

    // 若單盤檔沒寫 title，就用 index.json 的 title
    if (!game.title) game.title = entry.title;
    if (!game.id) game.id = entry.id;

    currentGame = game;
    renderAll();
  }

  function wireControls(){
    firstBtn.addEventListener("click", () => { step = 0; renderAll(); });
    prevBtn.addEventListener("click", () => { step = Math.max(0, step-1); renderAll(); });
    nextBtn.addEventListener("click", () => {
      const L = currentGame ? currentGame.moves.length : 0;
      step = Math.min(L, step+1);
      renderAll();
    });
    lastBtn.addEventListener("click", () => {
      const L = currentGame ? currentGame.moves.length : 0;
      step = L;
      renderAll();
    });

    window.addEventListener("keydown", (e) => {
      if (!currentGame) return;
      const L = currentGame.moves.length;
      if (e.key === "ArrowLeft") { if (step>0) { step--; renderAll(); } }
      if (e.key === "ArrowRight") { if (step<L) { step++; renderAll(); } }
      if (e.key === "Home") { step = 0; renderAll(); }
      if (e.key === "End") { step = L; renderAll(); }
    });
  }

  async function init(){
    try{
      wireControls();
      await loadIndex();
      await loadGame(0);
    } catch (err){
      showError(String(err?.message ?? err));
    }
  }

  init();
})();
</script>
</body>
</html>







